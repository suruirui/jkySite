function project3D(t,a,i,n){var o,r;t-=n.camX,a-=n.camY-8,i-=n.camZ,o=Math.atan2(t,i),r=Math.sqrt(t*t+i*i),t=Math.sin(o-n.yaw)*r,i=Math.cos(o-n.yaw)*r,o=Math.atan2(a,i),r=Math.sqrt(a*a+i*i),a=Math.sin(o-n.pitch)*r,i=Math.cos(o-n.pitch)*r;var e=t,s=i,c=2e3*(s-0)-0*(e-0),h=(1*(e-0)- -1e3*(s-0))/c,l=2e3/c;return i||(i=1e-9),h>0&&h<1&&l>0&&l<1?{x:n.cx+(2e3*h-1e3)*n.scale,y:n.cy+a/i*n.scale,d:t*t+a*a+i*i}:{d:-1}}function elevation(t,a,i){var n=Math.sqrt(t*t+a*a+i*i);return n&&i/n>=-1&&i/n<=1?Math.acos(i/n):1e-8}function rgb(t){t+=1e-6;var a=parseInt(16*(.5+.5*Math.sin(t))),i=parseInt(16*(.5+.5*Math.cos(t))),n=parseInt(16*(.5-.5*Math.sin(t)));return"#"+a.toString(16)+i.toString(16)+n.toString(16)}function interpolateColors(t,a,i){var n=i,o=1-n;return[o*t[0]+n*a[0],o*t[1]+n*a[1],o*t[2]+n*a[2]]}function rgbArray(t){return t+=1e-6,[parseInt(256*(.5+.5*Math.sin(t))),parseInt(256*(.5+.5*Math.cos(t))),parseInt(256*(.5-.5*Math.sin(t)))]}function colorString(t){var a=parseInt(t[0]),i=parseInt(t[1]),n=parseInt(t[2]);return"#"+("0"+a.toString(16)).slice(-2)+("0"+i.toString(16)).slice(-2)+("0"+n.toString(16)).slice(-2)}function process(t){if(t.points.length<t.initParticles)for(var a=0;a<5;++a)spawnParticle(t);var i,n,o;i=Math.atan2(t.camX,t.camZ),n=Math.sqrt(t.camX*t.camX+t.camZ*t.camZ),n-=Math.sin(t.frameNo/80)/25,o=Math.cos(t.frameNo/300)/165,t.camX=Math.sin(i+o)*n,t.camZ=Math.cos(i+o)*n,t.camY=15*-Math.sin(t.frameNo/220),t.yaw=Math.PI+i+o,t.pitch=elevation(t.camX,t.camZ,t.camY)-Math.PI/2;for(var o,a=0;a<t.points.length;++a)x=t.points[a].x,y=t.points[a].y,z=t.points[a].z,n=Math.sqrt(x*x+z*z)/1.0075,o=.1/(1+n*n/5),i=Math.atan2(x,z)+o,t.points[a].x=Math.sin(i)*n,t.points[a].z=Math.cos(i)*n,t.points[a].y+=t.points[a].vy*o*(2*(Math.sqrt(t.distributionRadius)-n)),(t.points[a].y>t.vortexHeight/2||n<.25)&&(t.points.splice(a,1),spawnParticle(t))}function drawFloor(t){for(var a,i,n,o,r,e,s=-25;s<=25;s+=1)for(var c=-25;c<=25;c+=1)a=2*s,n=2*c,i=t.floor,o=Math.sqrt(a*a+n*n),r=project3D(a,i-o*o/85,n,t),-1!=r.d&&(size=1+15e3/(1+r.d),(e=.15-.15*Math.pow(o/50,4))>0&&(t.ctx.fillStyle=colorString(interpolateColors(rgbArray(o/26-t.frameNo/40),[0,128,32],.5+Math.sin(o/6-t.frameNo/8)/2)),t.ctx.globalAlpha=e,t.ctx.fillRect(r.x-size/2,r.y-size/2,size,size)));t.ctx.fillStyle="#82f";for(var s=-25;s<=25;s+=1)for(var c=-25;c<=25;c+=1)a=2*s,n=2*c,i=-t.floor,o=Math.sqrt(a*a+n*n),r=project3D(a,i+o*o/85,n,t),-1!=r.d&&(size=1+15e3/(1+r.d),(e=.15-.15*Math.pow(o/50,4))>0&&(t.ctx.fillStyle=colorString(interpolateColors(rgbArray(-o/26-t.frameNo/40),[32,0,128],.5+Math.sin(-o/6-t.frameNo/8)/2)),t.ctx.globalAlpha=e,t.ctx.fillRect(r.x-size/2,r.y-size/2,size,size)))}function sortFunction(t,a){return a.dist-t.dist}function draw(t){t.ctx.globalAlpha=.15,t.ctx.fillStyle="#000",t.ctx.fillRect(0,0,canvas.width,canvas.height),drawFloor(t);for(var a,i,n,o,r,e=0;e<t.points.length;++e)i=t.points[e].x,n=t.points[e].y,o=t.points[e].z,a=project3D(i,n,o,t),-1!=a.d&&(t.points[e].dist=a.d,size=1+t.points[e].radius/(1+a.d),d=Math.abs(t.points[e].y),r=.8-.8*Math.pow(d/(t.vortexHeight/2),1e3),t.ctx.globalAlpha=r>=0&&r<=1?r:0,t.ctx.fillStyle=rgb(t.points[e].color),a.x>-1&&a.x<t.canvas.width&&a.y>-1&&a.y<t.canvas.height&&t.ctx.fillRect(a.x-size/2,a.y-size/2,size,size));t.points.sort(sortFunction)}function spawnParticle(t){var a,i;pt={},a=2*Math.PI*Math.random(),i=Math.sqrt(Math.random()*t.distributionRadius),pt.x=Math.sin(a)*i,pt.y=-t.vortexHeight/2,pt.vy=t.initV/20+Math.random()*t.initV,pt.z=Math.cos(a)*i,pt.radius=200+800*Math.random(),pt.color=pt.radius/1e3+t.frameNo/250,t.points.push(pt)}function frame(t){if(void 0===t){var t={};t.canvas=document.querySelector("canvas"),t.ctx=t.canvas.getContext("2d"),t.canvas.width=document.body.clientWidth,t.canvas.height=document.body.clientHeight,window.addEventListener("resize",function(){t.canvas.width=document.body.clientWidth,t.canvas.height=document.body.clientHeight,t.cx=t.canvas.width/2,t.cy=t.canvas.height/2},!0),t.frameNo=0,t.camX=0,t.camY=0,t.camZ=-14,t.pitch=elevation(t.camX,t.camZ,t.camY)-Math.PI/2,t.yaw=0,t.cx=t.canvas.width/2,t.cy=t.canvas.height/2,t.bounding=10,t.scale=500,t.floor=26.5,t.points=[],t.initParticles=1e3,t.initV=.01,t.distributionRadius=800,t.vortexHeight=25}t.frameNo++,requestAnimationFrame(function(){frame(t)}),process(t),draw(t)}frame();